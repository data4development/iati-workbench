<?xml version="1.0" encoding="UTF-8"?>
<project name="spreadsheet-iati"
  xmlns:if="ant:if"
  xmlns:unless="ant:unless">
  <description>
    Spreadsheet to IATI Engine
  </description>

  <target name="spreadsheet-iati"
    description="Create IATI XML file from spreadsheet and IATI input files."
    depends="generate-iati-partials, merge-iati">
  </target>

  <!--Merge activities from *.generated.xml into one file.-->
  <target name="merge-iati"
    depends="ls-tmp">
    <xslt
      basedir="/workspace/tmp"
      destdir="/workspace/tmp"
      in="/workspace/tmp/ls.xml"
      out="/workspace/src/iati-activities.xml"
      style="lib/iati.me/merge-activities.xslt"
    />
    <xslt
      basedir="/workspace/tmp"
      destdir="/workspace/tmp"
      in="/workspace/tmp/ls.xml"
      out="/workspace/src/iati-organisations.xml"
      style="lib/iati.me/merge-organisations.xslt"
    />
  </target>
  
  <!--Copy CSV files for further processing-->
  <target name="csv-csv">
    <copy todir="/workspace/tmp">
      <fileset dir="/workspace/input" includes="*.csv"/>
    </copy>
  </target>

  <!--Convert spreadsheets to CSV files for further processing.-->
  <target name="excel-csv"
    depends="init">
    <echo level="info">Convert spreadsheets to CSV files for further processing.</echo>

    <apply executable="soffice" dest="/workspace/tmp" verbose="false">
      <fileset dir="/workspace/input" includes="**/*.xls*"/>
      <mapper id="csv-out" type="regexp" from="(.+)\.xls.*$$" to="/workspace/tmp/\1.csv"/>

      <arg line="--headless"/>
      <!-- convert-to: explicitly save as UTF-8 (token 3, code=76) https://wiki.openoffice.org/wiki/Documentation/DevGuide/Spreadsheets/Filter_Options -->
      <arg line="--convert-to 'csv:Text - txt - csv (StarCalc):44,34,76,1'"/>
      <arg line="--outdir /workspace/tmp"/>
      <srcfile/>
    </apply>
  </target>

  <target name="sheets-iati" depends="sheets-csvxml">
    <available property="config-present" file="/workspace/config/csvxml-iati.xslt"/>
    <echo level="error" unless:set="config-present">
      There is no configuration how to transform these spreadsheets into IATI.
    </echo>
    <dependset>
      <srcfilelist dir="/workspace/config" files="csvxml-iati.xslt"/>
      <targetfileset dir="/workspace/tmp" includes="*.generated.xml"/>
    </dependset>
    <xslt if:set="config-present"
      basedir="/workspace/tmp"
      includes="*.csv.xml"
      destdir="/workspace/tmp"
      extension=".generated.xml"
      filenameparameter="filename"
      style="transform/csvxml-iati.xslt"
     />
  </target>

  <!-- Provide a place to add specific XML convertors -->
  <extension-point name="generate-iati-partials"
    depends="sheets-iati, iati-iati"/>

  <!--Transform existing IATI input files into a version with merge ids.-->
  <target name="iati-iati"
    description="Transform existing IATI input files into a version with merge ids."
    depends="init">
    <xslt
      basedir="/workspace/input/"
      includes="*.iati.xml"
      destdir="/workspace/tmp"
      extension=".generated.xml"
      style="transform/add-merge-ids.xslt"
     />
  </target>

  <target name="sheets-csvxml" depends="excel-csv, csv-csv">
    <sequential>
      <apply executable="basex" dest="/workspace/tmp" verbose="true">
        <fileset dir="/workspace/tmp" includes="*.csv"/>
        <srcfile prefix="-bfile="/>
        <arg value="-o"/>
        <targetfile/>
        <arg value="basex-queries/csv-csvxml.xq"/>
        <globmapper from="*.csv" to="*.csv.xml"/>
      </apply>
    </sequential>
  </target>

  <target name="spreadsheet-map" depends="clean, sheets-csvxml, ls-tmp" description="Create a map of the input files">
    <xslt basedir="tmp"
      destdir="output"
      in="/workspace/tmp/ls.xml"
      out="/workspace/output/csv-map.csv"
      style="lib/iati.me/csvxml-map.xslt"
    />
  </target>
  
  <!-- empty target to override if actions are needed after downloading remote files -->
  <extension-point name="postprocess-inputs"/>
  
  <!-- can  be overridden to do something with the IATI files before publishing -->
  <target name="postprocess-iati"/>
  
</project>
