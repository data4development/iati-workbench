<?xml version="1.0" encoding="UTF-8"?>
<project name="IATI Engine">
  <description>
    IATI Workbench
  </description>

  <!--
    Many build targets will be included from separate build files in their own
    folders. Only targets in this build file will benefit from command-line
    autocompletion.
  -->
  <import file="lib/build.xml"/>
  <import file="augment/build.xml"/>
  <import file="transform/build.xml"/>
  <import file="spreadsheet-iati/build.xml"/>
  <import file="data-quality/build.xml"/>
  <import file="visualisations/build.xml"/>

  <!-- Xspec tests -->
  <property environment="env"/>
  <property name="xspec.dir" location="tmp"/>
  <property name="saxon.jar" location="${env.SAXON_HOME}/saxon9he.jar"/>
  <import file="dev/xspec/build.xml"/>

  <target name="init"
    description="Set up the project environment.">

    <mkdir dir="/workspace/src"/>
    <mkdir dir="/workspace/config"/>
    <mkdir dir="/workspace/tmp"/>
    <mkdir dir="/workspace/input"/>
    <mkdir dir="/workspace/output"/>
    <mkdir dir="/workspace/remote"/>
    <mkdir dir="/workspace/reports"/>
  </target>

  <target name="clean"
    depends="init"
    description="Clean intermediary results.">
    <delete>
      <fileset dir="/workspace/tmp" includes="*"/>
    </delete>
    <echo>Intermediate results have been deleted from tmp directory.</echo>
  </target>

  <target name="more-up-down-stream" depends="init">
    <iati-query xquery="basex-queries/find-links-upstream-downstream.xq" src="/workspace/src" from="*.ids" to="*.extra"/>
  </target>

  <target name="find-links-upstream" depends="init" description="Find more upstream activities">
    <iati-query xquery="basex-queries/find-links-upstream.xq" src="/workspace/src" from="*.ids" to="*.ids.up"/>
    <concat>
      <fileset dir="tmp" includes="*.ids.up"/>
    </concat>
  </target>

  <target name="find-links-downstream" depends="init" description="Find more downstream activities">
    <iati-query xquery="basex-queries/find-links-downstream.xq" src="/workspace/src" from="*.ids" to="*.ids.down"/>
    <concat>
      <fileset dir="tmp" includes="*.ids.down"/>
    </concat>
  </target>

  <target name="get-activities" depends="init" description="Get the activities for each set of ids">
    <iati-query xquery="basex-queries/get-activities.xq" src="/workspace/src" from="*.ids" dest="/workspace/src" to="*.xml"/>
  </target>

  <target name="show-ids" depends="init">
    <iati-query xquery="basex-queries/show-ids.xq" src="/workspace/src" from="*.ids" to="*.txt"/>
  </target>

  <target name="spreadsheets-plus"
    description="Creates spreadsheets, data quality report and visualisations"
    depends="spreadsheet-iati,all-visualisations, report"
    />

  <target name="report"
    description="Creates an index page for the available report pages."
    depends="htdocs-skeleton">

    <copy todir="/workspace/reports/htdocs">
      <fileset dir="/workspace/src"/>
      <fileset dir="/workspace/output" includes="*.fods"/>
      <fileset dir="/workspace/output" includes="*.svg"/>
    </copy>

    <apply executable="xmlstarlet" output="/workspace/tmp/reports.xml">
      <arg line="ls"/>
      <dirset dir="/workspace/reports" includes="htdocs"/>
    </apply>

    <xslt
      basedir="/workspace/tmp"
      destdir="/workspace/reports/htdocs"
      in="/workspace/tmp/reports.xml"
      out="/workspace/reports/htdocs/index.html"
      style="lib/htdocs/index.xslt"
    />

    <!-- <delete file="/workspace/tmp/reports.xml"/> -->

  </target>
  <target name="test-tree"
    description="Test: render hierarchical list of projects">

    <copy todir="/workspace/reports/htdocs/css">
      <fileset dir="share/htdocs/css" includes="*.css"/>
    </copy>

    <delete>
      <fileset dir="/workspace/reports/htdocs" includes="*.list.html"/>
    </delete>
    <xslt
      basedir="/workspace/src"
      includes="*.xml"
      destdir="/workspace/reports"
      extension=".list.html"
      style="iati/tree.xslt"
     />

  </target>

</project>
