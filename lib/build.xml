<?xml version="1.0" encoding="UTF-8"?>
<project>
  <description>
    Library of build information.
  </description>

  <!--
    Pattern to work with BaseX as XQuery processor.
  -->
  <macrodef name="basexpipe">
    <attribute name="xquery"/>
    <attribute name="src" default="/workspace/tmp"/>
    <attribute name="from"/>
    <attribute name="fromP" default="@from"/>
    <attribute name="dest" default="/workspace/tmp"/>
    <attribute name="to"/>
    <attribute name="toP" default="@to"/>
    <sequential>
      <dependset>
        <sources>
          <file file="@{xquery}"/>
        </sources>
        <targetfileset dir="@{dest}">
          <patternset>
            <include name="@{to}"/>
          </patternset>
        </targetfileset>
      </dependset>
      <apply executable="basex" dest="@{dest}" verbose="true">
        <arg value="-i"/>
        <srcfile/>
        <arg value="-o"/>
        <targetfile/>
        <arg value="@{xquery}"/>
        <fileset dir="@{src}" includes="@{from}"/>
        <mapper type="glob" from="@{from}" to="@{to}"/>
      </apply>
    </sequential>
  </macrodef>

  <!-- Using BaseX on the IATI XML database -->
  <macrodef name="iati-query">
    <attribute name="xquery"/>
    <attribute name="src" default="/workspace/tmp"/>
    <attribute name="dest" default="/workspace/tmp"/>
    <attribute name="from"/>
    <attribute name="to"/>
    <sequential>
      <apply executable="basex" dest="@{dest}" verbose="true">
        <fileset dir="@{src}" includes="@{from}"/>
        <arg value="-iIATI"/>
        <srcfile prefix="-bfile="/>
        <arg value="-o"/>
        <targetfile/>
        <arg value="@{xquery}"/>
        <mapper type="glob" from="@{from}" to="@{to}"/>
      </apply>
    </sequential>
  </macrodef>

  <target name="htdocs-skeleton"
    depends="init">
    <apply executable="bower" verbose="true" force="true">
      <arg value="install"/>
      <file file="bower.json"/>
    </apply>

    <copy todir="/workspace/reports/htdocs">
      <fileset dir="share/htdocs"/>
    </copy>

    <copy todir="/workspace/reports/htdocs/lib/css">
      <fileset dir=".bower/components/bootstrap/dist/css"/>
      <fileset dir=".bower/components/fuelux/dist/css"/>
    </copy>
    <copy todir="/workspace/reports/htdocs/lib/fonts">
      <fileset dir=".bower/components/bootstrap/dist/fonts"/>
      <fileset dir=".bower/components/fuelux/dist/fonts"/>
    </copy>
    <copy todir="/workspace/reports/htdocs/lib/js">
      <fileset dir=".bower/components/jquery/dist"/>
      <fileset dir=".bower/components/bootstrap/dist/js"/>
    </copy>
  </target>

  <target name="make-iati"
    description="Merge activities within one file."
    depends="csvxml-iati, ls-tmp">
    <xslt
      basedir="/workspace/tmp"
      destdir="/workspace/tmp"
      in="/workspace/tmp/ls.xml"
      out="/workspace/src/iati.alpha.xml"
      style="lib/iati.me/merge-activities.xslt"
    />

  </target>

  <target name="csv-xml" depends="excel-csv">
    <sequential>
      <apply executable="basex" dest="/workspace/tmp" verbose="true">
        <fileset dir="/workspace/tmp" includes="*.csv"/>
        <srcfile prefix="-bfile="/>
        <arg value="-o"/>
        <targetfile/>
        <arg value="basex-queries/csv-csvxml.xq"/>
        <mapper type="glob" from="*.csv" to="*.csv.xml"/>
      </apply>
    </sequential>
  </target>

  <typedef resource="net/ggtools/grand/antlib.xml" classpath="/opt/ant/lib/grand-1.9.5.jar"/>
  <target name="ant-graph"
    description="Create a graph of the Ant targets.">
    <property name="dot.node.attributes" value="shape='box',fontname='sans-serif',fontsize='10',fillcolor='lightyellow',style='filled'"/>
    <property name="dot.link.attributes" value="fontname='sans-serif',fontsize='8',arrowsize='0.5',color='grey'"/>
    <property name="dot.mainnode.attributes" value="fillcolor='lightgreen'"/>
    <grand output="build.dot" outputconfigprefix="dot" showgraphname="true">
      <filter name="prefixed"/>
    </grand>

    <exec executable="dot">
      <arg line="-Tsvg -o build.svg build.dot"/>
    </exec>
    <echo>
      Ant target graph available as build.svg
    </echo>
  </target>

  <target name="ls-tmp" depends="init">
    <exec executable="xmlstarlet" output="/workspace/tmp/ls.xml">
      <arg line="ls /workspace/tmp"/>
    </exec>
  </target>
</project>
